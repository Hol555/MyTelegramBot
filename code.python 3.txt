#!/usr/bin/env python3
import os
import logging
import aiosqlite
import random
import asyncio
from datetime import datetime
from dotenv import load_dotenv
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import Application, CommandHandler, CallbackQueryHandler, ContextTypes

logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(message)s')
logger = logging.getLogger(__name__)

load_dotenv()
BOT_TOKEN = os.getenv('BOT_TOKEN')
ADMIN_IDS = [int(x) for x in os.getenv('ADMIN_IDS', '7591100907').split(',')]

class GameDatabase:
    def __init__(self, db_path='bot.db'):
        self.db_path = db_path
    
    async def init_db(self):
        """‚úÖ –°–æ–∑–¥–∞—ë—Ç –≤—Å–µ —Ç–∞–±–ª–∏—Ü—ã –ø—Ä–∞–≤–∏–ª—å–Ω–æ"""
        try:
            async with aiosqlite.connect(self.db_path) as db:
                # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ —Ç–∞–±–ª–∏—Ü—ã (–µ—Å–ª–∏ –µ—Å—Ç—å –æ—à–∏–±–∫–∏)
                await db.execute('DROP TABLE IF EXISTS games')
                await db.execute('DROP TABLE IF EXISTS users')
                
                # –°–æ–∑–¥–∞—ë–º –ø—Ä–∞–≤–∏–ª—å–Ω–æ
                await db.execute('''
                    CREATE TABLE users (
                        user_id INTEGER PRIMARY KEY,
                        username TEXT,
                        first_name TEXT,
                        total_score INTEGER DEFAULT 0,
                        games_played INTEGER DEFAULT 0,
                        best_score INTEGER DEFAULT 0,
                        created_at DATETIME DEFAULT CURRENT_TIMESTAMP
                    )
                ''')
                
                await db.execute('''
                    CREATE TABLE games (
                        id INTEGER PRIMARY KEY AUTOINCREMENT,
                        user_id INTEGER,
                        score INTEGER NOT NULL,
                        duration INTEGER DEFAULT 10,
                        created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
                        FOREIGN KEY (user_id) REFERENCES users(user_id)
                    )
                ''')
                
                await db.commit()
                logger.info("‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —Å–æ–∑–¥–∞–Ω–∞!")
        except Exception as e:
            logger.error(f"‚ùå DB Error: {e}")

    async def add_user(self, user_id, username, first_name):
        async with aiosqlite.connect(self.db_path) as db:
            await db.execute('''
                INSERT OR IGNORE INTO users (user_id, username, first_name)
                VALUES (?, ?, ?)
            ''', (user_id, username, first_name))
            await db.commit()

    async def add_score(self, user_id, score):
        async with aiosqlite.connect(self.db_path) as db:
            # –î–æ–±–∞–≤–ª—è–µ–º –∏–≥—Ä—É
            await db.execute('''
                INSERT INTO games (user_id, score) VALUES (?, ?)
            ''', (user_id, score))
            
            # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            await db.execute('''
                UPDATE users 
                SET total_score = total_score + ?,
                    games_played = games_played + 1,
                    best_score = MAX(best_score, ?)
                WHERE user_id = ?
            ''', (score, score, user_id))
            
            await db.commit()

    async def get_leaderboard(self, limit=10):
        async with aiosqlite.connect(self.db_path) as db:
            async with db.execute('''
                SELECT first_name, total_score, games_played, best_score
                FROM users 
                ORDER BY total_score DESC 
                LIMIT ?
            ''', (limit,)) as cursor:
                return await cursor.fetchall()

    async def get_user_stats(self, user_id):
        async with aiosqlite.connect(self.db_path) as db:
            async with db.execute('''
                SELECT total_score, games_played, best_score
                FROM users WHERE user_id = ?
            ''', (user_id,)) as cursor:
                result = await cursor.fetchone()
                return result or (0, 0, 0)

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
db = GameDatabase()
asyncio.create_task(db.init_db())

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    await db.add_user(user.id, user.username, user.first_name)
    
    keyboard = [
        [InlineKeyboardButton("üéÆ –ò–≥—Ä–∞—Ç—å!", callback_data="play_game")],
        [InlineKeyboardButton("üèÜ –¢–æ–ø-10", callback_data="leaderboard")],
        [InlineKeyboardButton("üìä –ú–æ—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞", callback_data="my_stats")]
    ]
    
    await update.message.reply_text(
        f"üéâ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, {user.first_name}!\n\n"
        "–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:",
        reply_markup=InlineKeyboardMarkup(keyboard)
    )

async def button_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    
    if query.data == "play_game":
        await start_game(query)
    elif query.data == "leaderboard":
        await show_leaderboard(query)
    elif query.data == "my_stats":
        await show_stats(query)
    elif query.data.startswith("end_game_"):
        await end_game(query)

async def start_game(query):
    """üéÆ –ù–∞—á–∏–Ω–∞–µ–º –∏–≥—Ä—É –Ω–∞ 15 —Å–µ–∫—É–Ω–¥"""
    query.from_user.id  # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    
    keyboard = [[InlineKeyboardButton("üñ±Ô∏è –ö–õ–ò–ö!", callback_data="clicking")]]
    
    await query.edit_message_text(
        "üéÆ **–ò–ì–†–ê –ù–ê–ß–ê–õ–ê–°–¨!**\n\n"
        "üî• –ö–ª–∏–∫–∞–π—Ç–µ –∫–Ω–æ–ø–∫—É 15 —Å–µ–∫—É–Ω–¥!\n"
        "‚è±Ô∏è –û—Å—Ç–∞–ª–æ—Å—å: 15 —Å–µ–∫\n"
        "üí∞ –û—á–∫–∏: 0",
        reply_markup=InlineKeyboardMarkup(keyboard),
        parse_mode="Markdown"
    )
    
    # –ñ–¥—ë–º 15 —Å–µ–∫—É–Ω–¥
    await asyncio.sleep(15)
    
    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å—á—ë—Ç (–≤ —Ä–µ–∞–ª—å–Ω–æ–π –∏–≥—Ä–µ —Å—á–∏—Ç–∞—Ç—å –∫–ª–∏–∫–∏)
    score = random.randint(25, 75)
    await end_game(query, score)

async def end_game(query, score):
    user_id = query.from_user.id
    await db.add_score(user_id, score)
    
    stats = await db.get_user_stats(user_id)
    total, games, best = stats
    
    keyboard = [
        [InlineKeyboardButton("üéÆ –ï—â—ë —Ä–∞–∑!", callback_data="play_game")],
        [InlineKeyboardButton("üèÜ –¢–æ–ø", callback_data="leaderboard")]
    ]
    
    await query.edit_message_text(
        f"üéâ **–ò–ì–†–ê –û–ö–û–ù–ß–ï–ù–ê!**\n\n"
        f"üí∞ **–í–∞—à —Å—á—ë—Ç: {score}**\n"
        f"üìä –í—Å–µ–≥–æ –æ—á–∫–æ–≤: **{total}**\n"
        f"‚ö° –ò–≥—Ä: **{games}**\n"
        f"üéØ –†–µ–∫–æ—Ä–¥: **{best}**",
        reply_markup=InlineKeyboardMarkup(keyboard),
        parse_mode="Markdown"
    )

async def show_leaderboard(query):
    top = await db.get_leaderboard(10)
    
    if not top:
        text = "üèÜ **–¢–û–ü –ï–©–Å –ü–£–°–¢!**\n–°—ã–≥—Ä–∞–π—Ç–µ –ø–µ—Ä–≤—ã–º! üéÆ"
    else:
        text = "üèÜ **–¢–û–ü-10 –ò–ì–†–û–ö–û–í:**\n\n"
        for i, (name, score, games, best) in enumerate(top, 1):
            medal = "ü•áü•àü•â"[i-1] if i <= 3 else f"{i}."
            text += f"{medal} **{name}**\n"
            text += f"üí∞ {score} | ‚ö° {games} –∏–≥—Ä | üéØ {best}\n\n"
    
    keyboard = [[InlineKeyboardButton("üéÆ –ò–≥—Ä–∞—Ç—å", callback_data="play_game")]]
    await query.edit_message_text(
        text, 
        reply_markup=InlineKeyboardMarkup(keyboard),
        parse_mode="Markdown"
    )

async def show_stats(query):
    user_id = query.from_user.id
    total, games, best = await db.get_user_stats(user_id)
    
    text = (
        f"üìä **–í–ê–®–ê –°–¢–ê–¢–ò–°–¢–ò–ö–ê**\n\n"
        f"üë§ @{query.from_user.username or 'No username'}\n"
        f"üí∞ **{total}** –æ—á–∫–æ–≤\n"
        f"‚ö° **{games}** –∏–≥—Ä\n"
        f"üéØ –†–µ–∫–æ—Ä–¥: **{best}**\n"
    )
    
    keyboard = [
        [InlineKeyboardButton("üéÆ –ò–≥—Ä–∞—Ç—å", callback_data="play_game")],
        [InlineKeyboardButton("üèÜ –¢–æ–ø", callback_data="leaderboard")]
    ]
    
    await query.edit_message_text(
        text,
        reply_markup=InlineKeyboardMarkup(keyboard),
        parse_mode="Markdown"
    )

def main():
    logger.info("üöÄ –ò–≥—Ä–æ–≤–æ–π –±–æ—Ç –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è...")
    app = Application.builder().token(BOT_TOKEN).build()
    
    app.add_handler(CommandHandler("start", start))
    app.add_handler(CallbackQueryHandler(button_callback))
    
    logger.info("‚úÖ –ë–æ—Ç –≥–æ—Ç–æ–≤! –û—Ç–ø—Ä–∞–≤—å—Ç–µ /start")
    app.run_polling()

if __name__ == '__main__':
    main()
